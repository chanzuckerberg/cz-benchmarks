---
- name: Create AWS GPU Instance
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - vars/main.yml

  tasks:
    - name: Find private AMI by name
      amazon.aws.ec2_ami_info:
        filters:
          name: "{{ ami_name }}"
          state: available
        owners: "{{ ami_owner_id }}"
        region: "{{ aws_region }}"
        profile: "{{ aws_profile }}"
      register: ami_info

    - name: Fail if no AMI found
      fail:
        msg: "No AMI found with name '{{ ami_name }}'. Please check the AMI name and try again."
      when: ami_info.images | length == 0

    - name: Create security group without any rules
      amazon.aws.ec2_security_group:
        name: "{{ instance_name }}-sg"
        description: Security group for {{ instance_name }}
        region: "{{ aws_region }}"
        profile: "{{ aws_profile }}"
        state: present
      register: security_group

    - name: Launch EC2 instance
      amazon.aws.ec2_instance:
        name: "{{ instance_name }}"
        image_id: "{{ ami_info.images[0].image_id }}"
        instance_type: "{{ instance_type }}"
        security_groups: "{{ security_group.group_name }}"
        iam_instance_profile: "{{ iam_instance_profile }}"
        volumes:
          - device_name: /dev/xvda
            ebs:
              volume_size: "{{ volume_size }}"
              volume_type: "{{ volume_type }}"
        region: "{{ aws_region }}"
        profile: "{{ aws_profile }}"
        state: present
        wait: yes
      register: ec2

    - name: Wait for instance to be in running state
      amazon.aws.ec2_instance_info:
        instance_ids:
          - "{{ ec2.instances[0].instance_id }}"
        region: "{{ aws_region }}"
        profile: "{{ aws_profile }}"
      register: instance_info
      until: instance_info.instances[0].state.name == "running"
      retries: 30
      delay: 10

    - name: Print instance information
      debug:
        msg:
          - "Instance Name: {{ instance_info.instances[0].tags.Name }}"
          - "Instance ID: {{ instance_info.instances[0].instance_id }}"
          - "Status: {{ instance_info.instances[0].state.name }}"
          - "Instance Type: {{ instance_info.instances[0].instance_type }}" 